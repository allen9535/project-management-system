name: EC2 CD

on:
    pull_request:
        branches: ['main']

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - name: Deploy to EC2
              env:
                  EC2_PRIVATE_KEY: ${{ secrets.EC2_PRIVATE_KEY }}
                  EC2_HOST: ${{ secrets.EC2_HOST }}
                  EC2_USER_NAME: ${{ secrets.EC2_USER_NAME }}
              run: |
                  echo "$EC2_PRIVATE_KEY" > ec2_private_key
                  chmod 600 ec2_private_key
                  ssh-keyscan -H ${EC2_HOST} >> ~/.ssh/known_hosts
                  ssh -o StrictHostKeyChecking=no -i ec2_private_key ${EC2_USER_NAME}@${EC2_HOST} '
                    cd /project-management &&
                    git checkout main &&
                    git fetch --all &&
                    git reset --hard origin/main &&
                    git pull origin main'
